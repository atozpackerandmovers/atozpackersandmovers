<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>A to Z Packers & Movers ‚Äî Live Tracking & Admin (15‚ÄëDay Persistence)</title>
  <meta name="description" content="Admin + Tracking in one file. Entries persist for at least 15 days and the homepage shows a full step-by-step status timeline for any Tracking ID.">
  <style>
    :root{
      --primary:#1e40af;
      --primary-2:#3b82f6;
      --accent:#f59e0b;
      --success:#059669;
      --danger:#dc2626;
      --bg:#f4f6f8;
      --text:#111827;
      --muted:#6b7280;
      --card:#ffffff;
      --shadow:0 10px 25px rgba(0,0,0,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';}
    a{color:var(--primary-2);text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:18px}
    header{
      position:sticky;top:0;z-index:30;background:rgba(248,250,252,.85);
      backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid #e5e7eb;
    }
    .brand{
      display:flex;align-items:center;gap:10px;font-weight:800;color:var(--primary);
    }
    .brand .logo{
      width:38px;height:38px;border-radius:11px;display:grid;place-items:center;
      background:linear-gradient(135deg,var(--primary),var(--primary-2));color:#fff;
      box-shadow:var(--shadow);
    }
    nav{display:flex;gap:10px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      border:1px solid #e5e7eb;background:#fff;padding:10px 14px;border-radius:12px;
      font-weight:600;cursor:pointer;transition:.2s;box-shadow:0 2px 8px rgba(0,0,0,.05);
    }
    .tab.active{background:var(--primary);border-color:var(--primary);color:#fff;box-shadow:var(--shadow)}
    main{display:grid;gap:22px;margin-top:18px}
    .card{
      background:var(--card);border:1px solid #e5e7eb;border-radius:var(--radius);
      box-shadow:var(--shadow);padding:18px;
    }
    .grid{display:grid;gap:14px}
    .grid.two{grid-template-columns:1fr 1fr}
    @media(max-width:900px){.grid.two{grid-template-columns:1fr}}
    h1{font-size:clamp(20px,3vw,28px);margin:0 0 6px 0}
    h2{font-size:clamp(18px,2.6vw,22px);margin:0 0 12px 0;color:#0f172a}
    h3{font-size:18px;margin:0 0 10px 0}
    label{font-size:14px;color:#334155;font-weight:600}
    input,select,textarea{
      width:100%;padding:11px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;outline:none;
    }
    textarea{min-height:80px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr; gap:12px}
    @media(max-width:700px){.row{grid-template-columns:1fr}}
    .btn{
      display:inline-flex;align-items:center;gap:8px;border:none;border-radius:12px;
      padding:10px 14px;font-weight:700;cursor:pointer;transition:.2s;
      background:var(--primary);color:#fff;box-shadow:0 6px 14px rgba(30,64,175,.25);
    }
    .btn.secondary{background:#111827}
    .btn.ghost{background:#fff;color:var(--primary);border:1px solid #e5e7eb;box-shadow:none}
    .btn.warn{background:var(--danger)}
    .btn.success{background:var(--success)}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-size:12px;color:#0f172a;
    }
    .muted{color:var(--muted);font-size:12px}
    .help{font-size:12px;color:#475569}
    .status-badge{
      display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;
      background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;font-weight:700
    }
    .badge-danger{background:#fee2e2;color:#b91c1c;border-color:#fecaca}
    .list{display:grid;gap:8px}
    .list-item{
      display:flex;justify-content:space-between;align-items:center;gap:12px;padding:10px 12px;
      border:1px solid #e5e7eb;background:#fff;border-radius:12px;
    }
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    /* Timeline */
    .timeline{position:relative;margin:0;padding:0;list-style:none}
    .timeline::before{content:"";position:absolute;left:18px;top:0;bottom:0;width:3px;background:#e5e7eb;border-radius:2px}
    .timeline-item{position:relative;display:grid;grid-template-columns:34px 1fr;gap:12px;padding:0 0 18px 0}
    .timeline-item:last-child{padding-bottom:0}
    .timeline-dot{
      width:16px;height:16px;border-radius:50%;background:var(--primary-2);border:3px solid #fff;
      position:absolute;left:12px;transform:translateY(4px);box-shadow:0 0 0 3px #dbeafe;
    }
    .timeline-card{
      padding:12px 14px;background:#fff;border:1px solid #e5e7eb;border-radius:14px;
      box-shadow:0 6px 14px rgba(0,0,0,.05);
    }
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media(max-width:900px){.kpi{grid-template-columns:repeat(2,1fr)}}
    .kpi .tile{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px}
    .tile .big{font-size:22px;font-weight:800}
    .ok{color:var(--success)} .bad{color:var(--danger)}
    .section-title{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .hidden{display:none !important}
    .sticky-cta{
      position:fixed;right:16px;bottom:16px;z-index:50;background:#fff;border:1px solid #e5e7eb;
      padding:10px 12px;border-radius:999px;display:flex;gap:8px;align-items:center;box-shadow:var(--shadow)
    }
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);z-index:60;display:none}
    .exp{font-size:12px;color:#475569}
    .divider{height:1px;background:#e5e7eb;margin:10px 0}
    /* Full-screen Auth Gate (never misses) */
    #authGate{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.66);z-index:9999}
    #authGate .card{background:#fff;border:1px solid #e5e7eb;border-radius:18px;box-shadow:var(--shadow);padding:16px;width:min(96%,520px)}
    #authGate h3{margin:0 0 8px 0}
    #authGate .row{display:grid;grid-template-columns:1fr 1fr; gap:12px}
    @media(max-width:700px){#authGate .row{grid-template-columns:1fr}}

    /* Fallback modal */
    .fallback-modal{position:fixed;inset:0;background:rgba(15,23,42,.45);display:flex;align-items:center;justify-content:center;z-index:80}
    .fallback-modal.hidden{display:none}
    .fallback-card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:var(--shadow);width:min(96%,460px);padding:16px}
    /* Login Required Overlay */
    #loginOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:90}
    #loginOverlay .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:var(--shadow);padding:18px;width:min(96%,420px);text-align:center}


  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div class="brand">
        <div class="logo">AZ</div>
        <div>
          <div style="font-size:14px;letter-spacing:.4px">A to Z Packers & Movers</div>
          <div class="muted" style="font-weight:600">Live Tracking & Admin</div>
        </div>
      </div>
      <nav class="tabs" role="tablist" aria-label="Primary">
        <button class="tab active" data-tab="home" aria-selected="true">Home / Track</button>
        <button class="tab" data-tab="admin" aria-selected="false" onclick="(window.isAuthed?null:openLoginDialog())">Admin Panel</button>
      </nav>
      <button class="btn ghost" id="loginBtn" aria-label="Admin Login" title="Admin Login" onclick="openLoginDialog()">üîê Admin Login</button>
    </div>
  </header>

  <main class="container">
    <!-- HOME / TRACK -->
    <section id="home" class="grid">
      <div class="card">
        <div class="section-title">
          <h1>Track Your Shipment</h1>
          <span class="status-badge" id="overdueBadge" style="display:none">Overdue Delivery</span>
        </div>
        <p class="help">Enter your <strong>Tracking ID</strong> to see the complete, step-by-step status history.</p>
        <div class="row" style="align-items:end">
          <div>
            <label for="trackInput">Tracking ID</label>
            <input id="trackInput" class="mono" placeholder="e.g., AZ250818-0001" autocomplete="off"/>
          </div>
          <div>
            <button class="btn" id="trackBtn">üîç Track Now</button>
          </div>
        </div>
      </div>

      <div id="trackResult" class="card hidden">
        <div class="section-title">
          <h2>Shipment Details</h2>
          <div id="currentStatusBadge" class="status-badge">Current: ‚Äî</div>
        </div>
        <div class="grid two" style="margin-top:8px">
          <div>
            <div class="chips">
              <div class="chip"><strong>Tracking:</strong> <span id="t_tracking" class="mono"></span></div>
              <div class="chip"><strong>Customer:</strong> <span id="t_customer"></span></div>
              <div class="chip"><strong>Phone:</strong> <a id="t_phone" href="#" target="_blank"></a></div>
            </div>
            <div style="margin-top:8px" class="help">
              <span id="t_service"></span>
            </div>
          </div>
          <div style="text-align:right">
            <div class="chips" style="justify-content:flex-end">
              <div class="chip"><strong>Pickup:</strong> <span id="t_pickup"></span></div>
              <div class="chip"><strong>Expected Delivery:</strong> <span id="t_expected"></span></div>
              <div class="chip"><strong>From‚ÄìTo:</strong> <span id="t_route"></span></div>
            </div>
            <div id="overdueText" class="muted" style="margin-top:6px"></div>
          </div>
        </div>

        <div class="divider"></div>
        <h3 style="margin:10px 0 10px 0">Status Timeline</h3>
        <ul id="timeline" class="timeline"></ul>
      </div>

      <div id="trackEmpty" class="card hidden">
        <h3>Tracking ID not found</h3>
        <p class="help">Please verify the ID and try again. If you just created the entry on a different device, tracking requires a shared database (server). This single-file version stores data <em>on this device</em> for reliability.</p>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="admin" class="grid hidden">
      <div class="card">
        <div class="section-title">
          <h1>Admin Panel</h1>
          <div class="chips">
            <span class="chip"><strong>Retention:</strong> At least <span id="retentionDaysLbl">15</span> days</span>
            <span class="chip"><strong>DB:</strong> <span id="dbMode">IndexedDB</span></span>
          </div>
        </div>
        <p class="help">New entries persist for a minimum of 15 days. Status updates are appended to the shipment‚Äôs history and instantly reflected in Tracking.</p>
        <div class="chips" style="margin-top:10px">
          <button class="btn success" id="newEntryBtn">‚ûï New Entry</button>
          <button class="btn ghost" id="refreshListBtn">üîÑ Refresh List</button>
          <button class="btn warn" id="cleanupBtn" title="Remove very old records (older than 60 days)">üßπ Cleanup (60+ days)</button>
        
          <button class="btn secondary" id="changePwBtn">üîí Change Login</button>
          <button class="btn ghost" id="logoutBtn">üö™ Logout</button>
        </div
      </div>

      <div class="card">
        <div class="section-title">
          <h2>Recent Shipments</h2>
          <span class="muted">Latest updated on top</span>
        </div>
        <div id="ordersList" class="list"></div>
      </div>

      <div class="card">
        <h2>Quick Help</h2>
        <ul class="help">
          <li>‚ÄúDestination In/Out‚Äù are flexible ‚Äî you can enter your own label (e.g., ‚ÄúReached Bhubaneswar Hub‚Äù).</li>
          <li>Tap <strong>Update Status</strong> to add Booking, Picked Up, Transit, Destination In, Destination Out, Out for Delivery, or Delivered.</li>
          <li>Delivered WhatsApp is a short message (auto-filled). Uses WhatsApp <span class="mono">+91 9338888550</span>.</li>
        </ul>
      </div>
    </section>
  </main>

  <!-- Sticky CTA -->
  <div class="sticky-cta">
    <a class="btn" href="https://wa.me/919338888550" target="_blank" rel="noopener">WhatsApp Us</a>
    <a class="btn ghost" id="goAdmin">Go to Admin</a>
  </div>

  <!-- Modal -->
  <dialog id="modal" style="border:none;border-radius:14px;padding:0;max-width:760px;width:96%;box-shadow:var(--shadow)">
    <form id="entryForm" method="dialog" style="padding:16px 16px 10px 16px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px">
        <h3 id="modalTitle">New Entry</h3>
        <button type="button" id="closeModal" class="btn ghost">‚úñ</button>
      </div>
      <div class="row">
        <div>
          <label>Customer Name</label>
          <input name="customerName" required placeholder="Full name"/>
        </div>
        <div>
          <label>Contact Number</label>
          <input name="customerPhone" required placeholder="+91 ‚Ä¶"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>From Location</label>
          <input name="fromLoc" required placeholder="Pickup city"/>
        </div>
        <div>
          <label>To Location</label>
          <input name="toLoc" required placeholder="Delivery city"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Pickup Date</label>
          <input type="date" name="pickupDate" required/>
        </div>
        <div>
          <label>Expected Delivery Date</label>
          <input type="date" name="expectedDate" required/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Select Type of Service</label>
          <select name="serviceType" required>
            <option value="Household Goods (Packing, Loading, Transportation, Unloading)">Household Goods (PLTU)</option>
            <option value="Vehicle Transport (Car/Bike)">Vehicle Transport (Car/Bike)</option>
            <option value="Office Shifting">Office Shifting</option>
            <option value="Local Move">Local Move</option>
            <option value="Storage">Storage</option>
          </select>
        </div>
        <div>
          <label>Estimated Distance (km)</label>
          <input type="number" name="distanceKm" inputmode="numeric" placeholder="e.g., 350"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Driver Name</label>
          <input name="driverName" placeholder="Driver"/>
        </div>
        <div>
          <label>Driver Phone</label>
          <input name="driverPhone" placeholder="+91 ‚Ä¶"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Vehicle Number</label>
          <input name="vehicleNo" placeholder="e.g., OD 05 BS 8855"/>
        </div>
        <div>
          <label>Special Instructions</label>
          <input name="special" placeholder="Any notes for this job"/>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div>
          <label>Tracking ID (auto)</label>
          <input name="trackingId" class="mono" readonly/>
          <div class="help">Auto-generated like AZ250818-0001</div>
        </div>
        <div style="display:flex;align-items:flex-end;gap:8px">
          <button class="btn success" id="saveEntryBtn">üíæ Save Entry</button>
          <button type="button" class="btn ghost" id="addBookedBtn" title="Add Booking status now">‚ûï Add Booking</button>
        </div>
      </div>
    </form>
  </dialog>
  <!-- Admin Authentication Dialog -->
  <dialog id="authDialog" style="border:none;border-radius:14px;padding:0;max-width:420px;width:92%;box-shadow:var(--shadow)">
    <form id="authForm" method="dialog" style="padding:16px">
      <h3 style="margin-bottom:8px">Admin Login</h3>
      <p class="help" style="margin-bottom:10px">Enter your Login ID and password to access the Admin Panel.</p>
      <label for="adminUser">Login ID</label>
      <input id="adminUser" type="text" placeholder="e.g., admin" autocomplete="username" required />
      <label for="adminPassword">Password</label>
      <input id="adminPassword" type="password" placeholder="Enter password" autocomplete="current-password" required />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button type="button" class="btn ghost" id="authCancelBtn">Cancel</button>
        <button type="submit" class="btn" id="authLoginBtn">Login</button>
      </div>
      <div class="muted" style="margin-top:10px">Tip: You can change this later from Admin ‚Üí üîí Change Login.</div>
    </form>
  </dialog>

  <!-- Change Password Dialog -->
  <dialog id="pwDialog" style="border:none;border-radius:14px;padding:0;max-width:480px;width:96%;box-shadow:var(--shadow)">
    <form id="pwForm" method="dialog" style="padding:16px">
      <h3 style="margin-bottom:8px">Change Admin Login</h3>
      <div class="row">
        <div>
          <label for="pwUser">New Login ID (optional)</label>
          <input id="pwUser" type="text" placeholder="Leave blank to keep current" autocomplete="username" />
        </div>
        <div>
          <label for="pwCurrent">Current Password</label>
          <input id="pwCurrent" type="password" placeholder="Current password" autocomplete="current-password" required />
        </div>
        <div>
          <label for="pwNew">New Password</label>
          <input id="pwNew" type="password" placeholder="At least 6 characters" autocomplete="new-password" required />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="pwConfirm">Confirm New Password</label>
          <input id="pwConfirm" type="password" placeholder="Repeat new password" autocomplete="new-password" required />
        </div>
        <div>
          <label for="pwRememberMins">Remember Login (minutes)</label>
          <input id="pwRememberMins" type="number" min="0" value="30" />
          <div class="help">How long to stay logged in after page refresh (uses session).</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button type="button" class="btn ghost" id="pwCancelBtn">Cancel</button>
        <button type="submit" class="btn success" id="pwSaveBtn">Save Password</button>
      </div>
    </form>
  </dialog>


  <div id="toast" class="toast"></div>

  <script>
  // ===== CONFIG =====
  // ===== AUTH CONFIG =====
  // ===== FULL-SCREEN AUTH GATE (simple & robust) =====
  function showAuthGate(){
    const g = document.getElementById('authGate');
    if(g){ g.style.display='flex'; }
  }
  function hideAuthGate(){
    const g = document.getElementById('authGate');
    if(g){ g.style.display='none'; }
  }
  async function handleAuthGateLogin(){
    const storedUser = localStorage.getItem(ADMIN_USER_KEY) || DEFAULT_ADMIN_USER;
    const storedHash = localStorage.getItem(ADMIN_PW_KEY) || '';
    const u = (document.getElementById('gateUser').value || '').trim();
    const p = document.getElementById('gatePass').value || '';
    const h = await sha256Hex(p);
    if(u === storedUser && h === storedHash){
      isAuthed = true;
      setSessionAuth(30);
      hideAuthGate();
      toast('Logged in as Admin');
      // Switch to Admin view
      const adminTab = document.querySelector('.tab[data-tab="admin"]');
      if(adminTab){ adminTab.classList.add('active'); }
      const homeTab = document.querySelector('.tab[data-tab="home"]');
      if(homeTab){ homeTab.classList.remove('active'); }
      document.getElementById('home').classList.add('hidden');
      document.getElementById('admin').classList.remove('hidden');
      const go = document.getElementById('goAdmin'); if(go) go.textContent='Go to Home';
      if (window.afterAdminLoginSwitch) { try { window.afterAdminLoginSwitch(); } catch(e){} }
    }else{
      toast('Incorrect Login ID or Password');
    }
  }

  // Simple overlay helper if events fail
  function showLoginOverlay(){
    const ov = document.getElementById('loginOverlay');
    if(ov){ ov.style.display='flex'; }
    // auto open dialog too, so user sees it immediately
    openLoginDialog();
  }

  const ADMIN_USER_KEY = 'admin_user_v1';
  const ADMIN_PW_KEY = 'admin_pw_hash_v1';
  const ADMIN_SESSION_KEY = 'admin_authed_until';
  const DEFAULT_ADMIN_USER = 'admin';
  const DEFAULT_ADMIN_PASSWORD = 'AZ@2025'; // You can change after login via "Change Password".
  const DIALOG_OK = typeof HTMLDialogElement !== 'undefined' && !!document.createElement('dialog').showModal;
  let isAuthed = false;

  async function sha256Hex(str){
    const enc = new TextEncoder();
    const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
    const bytes = new Uint8Array(buf);
    return Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  async function ensureAdminCredentials(){
    let hash = localStorage.getItem(ADMIN_PW_KEY);
    if(!hash){
      hash = await sha256Hex(DEFAULT_ADMIN_PASSWORD);
      localStorage.setItem(ADMIN_PW_KEY, hash);
    }
    if(!localStorage.getItem(ADMIN_USER_KEY)){
      localStorage.setItem(ADMIN_USER_KEY, DEFAULT_ADMIN_USER);
    }
  }

  function checkSessionAuth(){
    const until = sessionStorage.getItem(ADMIN_SESSION_KEY);
    if(!until) return false;
    const now = Date.now();
    return now < Number(until);
  }

  function setSessionAuth(minutes=30){
    const ms = Math.max(0, minutes|0) * 60 * 1000;
    const until = Date.now() + ms;
    sessionStorage.setItem(ADMIN_SESSION_KEY, String(until));
  }

  
  
  async function openLoginDialog(){
    const useDialog = DIALOG_OK && document.getElementById('authDialog');
    const storedUser = localStorage.getItem(ADMIN_USER_KEY) || DEFAULT_ADMIN_USER;
    const storedHash = localStorage.getItem(ADMIN_PW_KEY) || '';
    if(useDialog){
      const dlg = document.getElementById('authDialog');
      const form = document.getElementById('authForm');
      const user = document.getElementById('adminUser');
      const input = document.getElementById('adminPassword');
      const cancelBtn = document.getElementById('authCancelBtn');

      user.value = '';
      input.value = '';
      dlg.showModal();

      function onCancel(){ dlg.close(); form.removeEventListener('submit', onSubmit); cancelBtn.removeEventListener('click', onCancel); }
      async function onSubmit(e){
        e.preventDefault();
        const givenUser = (user.value || '').trim();
        const givenHash = await sha256Hex(input.value);
        if(givenUser === storedUser && givenHash === storedHash){
          isAuthed = true;
          setSessionAuth(30);
          dlg.close();
          toast('Logged in as Admin');
          // Switch view
          document.querySelector('.tab[data-tab="admin"]').classList.add('active');
          document.querySelector('.tab[data-tab="home"]').classList.remove('active');
          document.getElementById('home').classList.add('hidden');
          document.getElementById('admin').classList.remove('hidden');
          document.getElementById('goAdmin').textContent='Go to Home';
          if (window.afterAdminLoginSwitch) { try { window.afterAdminLoginSwitch(); } catch(e){} }
        }else{
          toast('Incorrect Login ID or Password');
        }
      }
      form.addEventListener('submit', onSubmit);
      cancelBtn.addEventListener('click', onCancel);
      return;
    }
    // Fallback path
    const wrap = document.getElementById('authFallback');
    const user2 = document.getElementById('adminUserFallback');
    const input2 = document.getElementById('adminPasswordFallback');
    const btnLogin = document.getElementById('authFallbackLogin');
    const btnCancel = document.getElementById('authFallbackCancel');
    const btnClose = document.getElementById('authFallbackClose');
    if(!wrap){ alert('Login dialog missing.'); return; }
    user2.value=''; input2.value='';
    wrap.classList.remove('hidden');
    async function closeAll(){
      wrap.classList.add('hidden');
      btnLogin.removeEventListener('click', onLogin);
      btnCancel.removeEventListener('click', closeAll);
      btnClose.removeEventListener('click', closeAll);
    }
    async function onLogin(){
      const givenUser = (user2.value || '').trim();
      const givenHash = await sha256Hex(input2.value);
      if(givenUser === storedUser && givenHash === storedHash){
        isAuthed = true;
        setSessionAuth(30);
        closeAll();
        toast('Logged in as Admin');
        // Switch view
        document.querySelector('.tab[data-tab="admin"]').classList.add('active');
        document.querySelector('.tab[data-tab="home"]').classList.remove('active');
        document.getElementById('home').classList.add('hidden');
        document.getElementById('admin').classList.remove('hidden');
        document.getElementById('goAdmin').textContent='Go to Home';
        if (window.afterAdminLoginSwitch) { try { window.afterAdminLoginSwitch(); } catch(e){} }
      }else{
        toast('Incorrect Login ID or Password');
      }
    }
    btnLogin.addEventListener('click', onLogin);
    btnCancel.addEventListener('click', closeAll);
    btnClose.addEventListener('click', closeAll);
  }

      async function onSubmit(e){
        e.preventDefault();
        const stored = localStorage.getItem(ADMIN_PW_KEY) || '';
        const given = await sha256Hex(input.value);
        if(given === stored){
          isAuthed = true;
          setSessionAuth(30);
          dlg.close();
          \1
          if (window.afterAdminLoginSwitch) { try { window.afterAdminLoginSwitch(); } catch(e){} }
          // Switch view
          document.querySelector('.tab[data-tab="admin"]').classList.add('active');
          document.querySelector('.tab[data-tab="home"]').classList.remove('active');
          document.getElementById('home').classList.add('hidden');
          document.getElementById('admin').classList.remove('hidden');
          document.getElementById('goAdmin').textContent='Go to Home';
        }else{
          toast('Incorrect password');
        }
      }
      form.addEventListener('submit', onSubmit);
      cancelBtn.addEventListener('click', onCancel);
      return;
    }
    // Fallback path
    const wrap = document.getElementById('authFallback');
    const input2 = document.getElementById('adminPasswordFallback');
    const btnLogin = document.getElementById('authFallbackLogin');
    const btnCancel = document.getElementById('authFallbackCancel');
    const btnClose = document.getElementById('authFallbackClose');
    input2.value='';
    wrap.classList.remove('hidden');
    async function closeAll(){
      wrap.classList.add('hidden');
      btnLogin.removeEventListener('click', onLogin);
      btnCancel.removeEventListener('click', closeAll);
      btnClose.removeEventListener('click', closeAll);
    }
    async function onLogin(){
      const stored = localStorage.getItem(ADMIN_PW_KEY) || '';
      const given = await sha256Hex(input2.value);
      if(given === stored){
        isAuthed = true;
        setSessionAuth(30);
        closeAll();
        toast('Logged in as Admin');
        // Switch view
        document.querySelector('.tab[data-tab="admin"]').classList.add('active');
        document.querySelector('.tab[data-tab="home"]').classList.remove('active');
        document.getElementById('home').classList.add('hidden');
        document.getElementById('admin').classList.remove('hidden');
        document.getElementById('goAdmin').textContent='Go to Home';
      }else{
        toast('Incorrect password');
      }
    }
    btnLogin.addEventListener('click', onLogin);
    btnCancel.addEventListener('click', closeAll);
    btnClose.addEventListener('click', closeAll);
  }

    async function onSubmit(e){
      e.preventDefault();
      const stored = localStorage.getItem(ADMIN_PW_KEY) || '';
      const given = await sha256Hex(input.value);
      if(given === stored){
        isAuthed = true;
        setSessionAuth(30);
        dlg.close();
        toast('Logged in as Admin');
        // Switch to Admin tab now
        document.querySelector('.tab[data-tab="admin"]').classList.add('active');
        document.querySelector('.tab[data-tab="home"]').classList.remove('active');
        document.getElementById('home').classList.add('hidden');
        document.getElementById('admin').classList.remove('hidden');
        document.getElementById('goAdmin').textContent='Go to Home';
      }else{
        toast('Incorrect password');
      }
    }
    form.addEventListener('submit', onSubmit);
    cancelBtn.addEventListener('click', onCancel);
  }

  function logoutAdmin(){
    isAuthed = false;
    sessionStorage.removeItem(ADMIN_SESSION_KEY);
    toast('Logged out');
    // Go back to Home view
    document.querySelector('.tab[data-tab="home"]').click();
  }

  
  async function openChangePasswordDialog(){
    const dlg = document.getElementById('pwDialog');
    const form = document.getElementById('pwForm');
    const cur = document.getElementById('pwCurrent');
    const nw = document.getElementById('pwNew');
    const cf = document.getElementById('pwConfirm');
    const mins = document.getElementById('pwRememberMins');
    const newUser = document.getElementById('pwUser');
    const cancelBtn = document.getElementById('pwCancelBtn');

    cur.value = ''; nw.value = ''; cf.value = ''; newUser.value='';
    dlg.showModal();

    function onCancel(){ dlg.close(); form.removeEventListener('submit', onSubmit); cancelBtn.removeEventListener('click', onCancel); }
    async function onSubmit(e){
      e.preventDefault();
      const stored = localStorage.getItem(ADMIN_PW_KEY) || '';
      const given = await sha256Hex(cur.value);
      if(given !== stored){ toast('Current password is incorrect'); return; }
      if(nw.value && nw.value.length < 6){ toast('New password must be at least 6 characters'); return; }
      if(nw.value && (nw.value !== cf.value)){ toast('New password and confirmation do not match'); return; }
      if(newUser.value && newUser.value.trim().length < 3){ toast('Login ID should be at least 3 characters'); return; }

      if(nw.value){
        const newHash = await sha256Hex(nw.value);
        localStorage.setItem(ADMIN_PW_KEY, newHash);
      }
      if(newUser.value && newUser.value.trim()){
        localStorage.setItem(ADMIN_USER_KEY, newUser.value.trim());
      }
      const remember = Math.max(0, parseInt(mins.value || '30', 10));
      setSessionAuth(remember);
      dlg.close();
      toast('Login updated');
    }
    form.addEventListener('submit', onSubmit);
    cancelBtn.addEventListener('click', onCancel);
  }

    async function onSubmit(e){
      e.preventDefault();
      const stored = localStorage.getItem(ADMIN_PW_KEY) || '';
      const given = await sha256Hex(cur.value);
      if(given !== stored){ toast('Current password is incorrect'); return; }
      if(nw.value.length < 6){ toast('New password must be at least 6 characters'); return; }
      if(nw.value !== cf.value){ toast('New password and confirmation do not match'); return; }
      const newHash = await sha256Hex(nw.value);
      localStorage.setItem(ADMIN_PW_KEY, newHash);
      const remember = Math.max(0, parseInt(mins.value || '30', 10));
      setSessionAuth(remember);
      dlg.close();
      toast('Password updated');
    }
    form.addEventListener('submit', onSubmit);
    cancelBtn.addEventListener('click', onCancel);
  }

  const PHONE_WHATSAPP = '919338888550'; // E.164 without +
  const RETENTION_DAYS_MIN = 15;         // keep at least this many days
  const CLEANUP_THRESHOLD_DAYS = 60;     // cleanup tool removes older than this

  // ===== UTILITIES =====
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmtDate = iso => {
    if(!iso) return '‚Äî';
    const d = new Date(iso);
    return d.toLocaleDateString(undefined, {year:'numeric', month:'short', day:'2-digit'}) +
           ' ' + d.toLocaleTimeString(undefined, {hour:'2-digit', minute:'2-digit'});
  };
  const fmtOnlyDate = iso => {
    if(!iso) return '‚Äî';
    const d = new Date(iso);
    return d.toLocaleDateString(undefined, {year:'numeric', month:'short', day:'2-digit'});
  };
  const todayISO = () => new Date().toISOString();
  const daysBetween = (aISO,bISO) => Math.floor((new Date(aISO)-new Date(bISO))/(1000*60*60*24));
  const toast = (msg, ms=1800)=>{ const t=$("#toast"); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', ms); };

  // ===== ID GENERATOR =====
  function generateTrackingId(){
    const d = new Date();
    const y = String(d.getFullYear()).slice(2);
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da= String(d.getDate()).padStart(2,'0');
    const rand = Math.floor(Math.random()*9000)+1000;
    return `AZ${y}${m}${da}-${rand}`;
  }

  // ===== STORAGE LAYER: IndexedDB with localStorage fallback =====
  let DB_MODE = 'IndexedDB';
  const DB_NAME = 'atoz_movers_db_v2';
  const DB_VERSION = 1;
  let idb;

  function openDB(){
    return new Promise((resolve,reject)=>{
      if(!('indexedDB' in window)){ DB_MODE='localStorage'; $("#dbMode").textContent = DB_MODE; resolve(null); return; }
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = (e)=>{
        const db = e.target.result;
        if(!db.objectStoreNames.contains('orders')){
          const store = db.createObjectStore('orders',{keyPath:'trackingId'});
          store.createIndex('lastUpdated','lastUpdated',{unique:false});
        }
      };
      req.onsuccess = (e)=>{ idb = e.target.result; resolve(idb); };
      req.onerror = ()=>{ DB_MODE='localStorage'; $("#dbMode").textContent = DB_MODE; resolve(null); };
    });
  }

  async function dbPut(order){
    if(DB_MODE==='localStorage'){
      let all = JSON.parse(localStorage.getItem('orders')||'{}');
      all[order.trackingId]=order;
      localStorage.setItem('orders', JSON.stringify(all));
      return;
    }
    return new Promise((resolve,reject)=>{
      const tx = idb.transaction('orders','readwrite');
      tx.oncomplete=()=>resolve();
      tx.onerror=e=>reject(e.target.error);
      tx.objectStore('orders').put(order);
    });
  }

  async function dbGet(trackingId){
    if(DB_MODE==='localStorage'){
      const all = JSON.parse(localStorage.getItem('orders')||'{}');
      return all[trackingId] || null;
    }
    return new Promise((resolve,reject)=>{
      const tx = idb.transaction('orders','readonly');
      const req = tx.objectStore('orders').get(trackingId);
      req.onsuccess = ()=> resolve(req.result || null);
      req.onerror = e => reject(e.target.error);
    });
  }

  async function dbGetAll(){
    if(DB_MODE==='localStorage'){
      const all = JSON.parse(localStorage.getItem('orders')||'{}');
      return Object.values(all);
    }
    return new Promise((resolve,reject)=>{
      const tx = idb.transaction('orders','readonly');
      const req = tx.objectStore('orders').getAll();
      req.onsuccess = ()=> resolve(req.result || []);
      req.onerror = e => reject(e.target.error);
    });
  }

  async function dbDelete(trackingId){
    if(DB_MODE==='localStorage'){
      const all = JSON.parse(localStorage.getItem('orders')||'{}');
      delete all[trackingId];
      localStorage.setItem('orders', JSON.stringify(all));
      return;
    }
    return new Promise((resolve,reject)=>{
      const tx = idb.transaction('orders','readwrite');
      tx.oncomplete=()=>resolve();
      tx.onerror = e => reject(e.target.error);
      tx.objectStore('orders').delete(trackingId);
    });
  }

  // ===== BUSINESS LOGIC =====
  const STATUS_CODES = {
    BOOKED:'Booking Confirmed',
    PICKED:'Picked Up',
    TRANSIT:'Transit',
    DEST_IN:'Destination In',
    DEST_OUT:'Destination Out',
    OFD:'Out for Delivery',
    DELIVERED:'Delivered'
  };

  function newOrderFromForm(f){
    const trackingId = f.trackingId.value || generateTrackingId();
    const now = todayISO();
    return {
      trackingId,
      createdAt: now,
      lastUpdated: now,
      retentionDays: RETENTION_DAYS_MIN,
      customer: { name:f.customerName.value.trim(), phone:f.customerPhone.value.trim() },
      route: { from:f.fromLoc.value.trim(), to:f.toLoc.value.trim() },
      pickupDate: f.pickupDate.value,
      expectedDelivery: f.expectedDate.value,
      serviceType: f.serviceType.value,
      driver: { name:f.driverName.value.trim(), phone:f.driverPhone.value.trim(), vehicle:f.vehicleNo.value.trim() },
      distanceKm: Number(f.distanceKm.value || 0),
      special: f.special.value.trim(),
      statuses: [] // start empty; admin can click "Add Booking" or save and then update
    };
  }

  async function addStatus(trackingId, code, customLabel=null, note=''){
    const order = await dbGet(trackingId);
    if(!order) return;
    const label = customLabel || STATUS_CODES[code] || code;
    const entry = { code, label, note, time: todayISO() };
    order.statuses.push(entry);
    order.lastUpdated = entry.time;
    await dbPut(order);
    return entry;
  }

  function isOverdue(order){
    if(!order || !order.expectedDelivery) return false;
    const now = new Date();
    const due = new Date(order.expectedDelivery + 'T23:59:59');
    const delivered = order.statuses.some(s=>s.code==='DELIVERED');
    return !delivered && now > due;
  }

  async function cleanupVeryOld(){
    const all = await dbGetAll();
    const now = new Date();
    let removed = 0;
    for(const o of all){
      const last = new Date(o.lastUpdated || o.createdAt || now);
      const ageDays = Math.floor((now - last)/(1000*60*60*24));
      if(ageDays > CLEANUP_THRESHOLD_DAYS){
        await dbDelete(o.trackingId);
        removed++;
      }
    }
    toast(`Cleanup complete. Removed ${removed} record(s) older than ${CLEANUP_THRESHOLD_DAYS} days.`);
    renderOrders();
  }

  // ===== RENDERING =====
  function renderOrderRow(order){
    const overdue = isOverdue(order);
    const delivered = order.statuses.some(s=>s.code==='DELIVERED');
    const current = order.statuses[order.statuses.length-1];
    const currentLabel = current ? current.label : '‚Äî';
    const daysOld = Math.abs(daysBetween(todayISO(), order.createdAt));
    return `
      <div class="list-item">
        <div style="min-width:220px">
          <div style="font-weight:800">${order.customer.name}</div>
          <div class="muted mono">${order.trackingId}</div>
        </div>
        <div style="flex:1">
          <div class="chips">
            <span class="chip"><strong>From‚ÄìTo:</strong> ${order.route.from} ‚Üí ${order.route.to}</span>
            <span class="chip"><strong>Pickup:</strong> ${order.pickupDate || '‚Äî'}</span>
            <span class="chip"><strong>ETA:</strong> ${order.expectedDelivery || '‚Äî'}</span>
          </div>
          <div class="muted">Last Updated: ${fmtDate(order.lastUpdated)} ‚Ä¢ Created: ${fmtDate(order.createdAt)} ‚Ä¢ Age: ${daysOld} day(s)</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <span class="status-badge ${overdue?'badge-danger':''}">Current: ${currentLabel}</span>
          ${delivered ? '<span class="chip ok">Delivered</span>' : (overdue?'<span class="chip bad">Overdue</span>':'')}
          <button class="btn ghost" data-act="update" data-id="${order.trackingId}">Update Status</button>
          <button class="btn" data-act="track" data-id="${order.trackingId}">Open Tracking</button>
          <button class="btn warn" data-act="delete" data-id="${order.trackingId}" title="Delete after 60+ days only">Delete</button>
        </div>
      </div>
    `;
  }

  async function renderOrders(){
    const list = $("#ordersList");
    const all = await dbGetAll();
    all.sort((a,b)=> new Date(b.lastUpdated) - new Date(a.lastUpdated));
    list.innerHTML = all.map(renderOrderRow).join('') || '<div class="help">No entries yet. Click <strong>New Entry</strong> to add one.</div>';
  }

  function renderTimeline(order){
    $("#trackResult").classList.add('hidden');
    $("#trackEmpty").classList.add('hidden');
    $("#overdueBadge").style.display='none';
    $("#overdueText").textContent='';

    if(!order){
      $("#trackEmpty").classList.remove('hidden');
      return;
    }

    // Top details
    $("#t_tracking").textContent = order.trackingId;
    $("#t_customer").textContent = order.customer.name || '‚Äî';
    const phoneHref = order.customer.phone ? `https://wa.me/${order.customer.phone.replace(/\D/g,'')}` : '#';
    $("#t_phone").href = phoneHref;
    $("#t_phone").textContent = order.customer.phone || '‚Äî';
    $("#t_service").textContent = order.serviceType || '';
    $("#t_pickup").textContent = order.pickupDate || '‚Äî';
    $("#t_expected").textContent = order.expectedDelivery || '‚Äî';
    $("#t_route").textContent = `${order.route.from || '‚Äî'} ‚Üí ${order.route.to || '‚Äî'}`;

    const overdue = isOverdue(order);
    if(overdue){
      $("#overdueBadge").style.display='inline-flex';
      const due = order.expectedDelivery || '';
      $("#overdueText").textContent = `Expected on ${due}. Current status is pending.`;
    }

    // Current status
    const current = order.statuses[order.statuses.length-1];
    $("#currentStatusBadge").textContent = 'Current: ' + (current ? current.label : '‚Äî');

    // Timeline items
    const tl = $("#timeline");
    if(!order.statuses.length){
      tl.innerHTML = '<li class="help">No status yet. Please ask admin to update.</li>';
    }else{
      tl.innerHTML = order.statuses.map(s=>`
        <li class="timeline-item">
          <span class="timeline-dot"></span>
          <div></div>
          <div class="timeline-card">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
              <div style="font-weight:800">${s.label}</div>
              <div class="muted mono">${fmtDate(s.time)}</div>
            </div>
            ${s.note ? `<div class="help" style="margin-top:6px">${s.note}</div>`:''}
          </div>
        </li>
      `).join('');
    }

    $("#trackResult").classList.remove('hidden');
    // Scroll to results smoothly
    document.getElementById('trackResult').scrollIntoView({behavior:'smooth', block:'start'});
  }

  // ===== INTERACTIONS =====
  function setupTabs(){
    $$(".tab").forEach(btn=>{
      btn.addEventListener('click',async ()=>{
        $$(".tab").forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        $("#home").classList.toggle('hidden', tab!=='home');
        $("#admin").classList.toggle('hidden', tab!=='admin');
        btn.setAttribute('aria-selected', 'true');
        // update sticky
        if(tab==='admin'){ $("#goAdmin").textContent='Go to Home'; } else { $("#goAdmin").textContent='Go to Admin'; }
      });
    });
    $("#goAdmin").addEventListener('click',()=>{
      const isAdminHidden = $("#admin").classList.contains('hidden');
      document.querySelector(`.tab[data-tab="${isAdminHidden?'admin':'home'}"]`).click();
    });
  }

  function openNewEntryModal(){
    const dialog = $("#modal");
    const f = $("#entryForm");
    $("#modalTitle").textContent = 'New Entry';
    f.reset();
    f.trackingId.value = generateTrackingId();
    dialog.showModal();
  }
  function closeModal(){ $("#modal").close(); }

  async function saveEntryFromModal(){
    const f = $("#entryForm");
    if(!f.reportValidity()) return;
    const order = newOrderFromForm(f);
    await dbPut(order);
    toast('Entry saved');
    closeModal();
    renderOrders();
    // Pre-fill first status quickly if user hit "Add Booking"
    return order;
  }

  async function addBookingFromModal(){
    const f = $("#entryForm");
    if(!f.trackingId.value){ f.trackingId.value = generateTrackingId(); }
    if(!f.customerName.value.trim() || !f.customerPhone.value.trim() || !f.fromLoc.value.trim() || !f.toLoc.value.trim() || !f.pickupDate.value || !f.expectedDate.value){
      toast('Fill the form first, then click "Add Booking".');
      return;
    }
    // Save entry (if new), then add booking
    const order = newOrderFromForm(f);
    await dbPut(order);
    await addStatus(order.trackingId,'BOOKED',null,'Booking created.');
    toast('Booking status added');
  }

  async function handleOrdersListClick(e){
    const btn = e.target.closest('button');
    if(!btn) return;
    const act = btn.dataset.act;
    const id = btn.dataset.id;
    if(act==='track'){
      $("#trackInput").value = id;
      document.querySelector('.tab[data-tab="home"]').click();
      $("#trackBtn").click();
    }else if(act==='update'){
      // status selection popup
      const options = [
        {code:'BOOKED', label:'Booking Confirmed'},
        {code:'PICKED', label:'Picked Up'},
        {code:'TRANSIT', label:'Transit'},
        {code:'DEST_IN', label:'Destination In (custom label)'},
        {code:'DEST_OUT', label:'Destination Out (custom label)'},
        {code:'OFD', label:'Out for Delivery'},
        {code:'DELIVERED', label:'Delivered'}
      ];
      const choice = prompt(
        'Update Status:\n' +
        options.map(o=>`- ${o.code}: ${o.label}`).join('\n') +
        '\n\nType the CODE to add (e.g., TRANSIT).'
      );
      if(!choice) return;
      const code = choice.trim().toUpperCase();
      const opt = options.find(o=>o.code===code);
      if(!opt){ toast('Invalid code'); return; }

      let customLabel=null;
      if(code==='DEST_IN' || code==='DEST_OUT'){
        customLabel = prompt('Enter custom label (e.g., "Reached Bhubaneswar Hub"):', STATUS_CODES[code]) || STATUS_CODES[code];
      }
      const note = prompt('Optional note to save with this status:', '') || '';
      const s = await addStatus(id, code, customLabel, note);
      if(!s){ toast('Failed to update'); return; }
      // Quick WhatsApp for Delivered
      if(code==='DELIVERED'){
        const msg = encodeURIComponent(`Your shipment ${id} has been delivered. Thank you for choosing A to Z Packers & Movers.`);
        window.open(`https://wa.me/${PHONE_WHATSAPP}?text=${msg}`,'_blank');
      }
      toast('Status added: ' + (customLabel||STATUS_CODES[code]));
      renderOrders();
    }else if(act==='delete'){
      const ok = confirm('Delete this record? Recommended only for records older than 60 days.');
      if(!ok) return;
      await dbDelete(id);
      toast('Deleted');
      renderOrders();
    }
  }

  async function trackLookup(){
    const id = $("#trackInput").value.trim();
    if(!id){ toast('Enter a Tracking ID'); return; }
    const order = await dbGet(id);
    renderTimeline(order);
  }

  async function ensureRetention(){
    // This ensures we never purge anything under 15 days old.
    // We only purge in cleanup() which uses 60+ days threshold.
    $("#retentionDaysLbl").textContent = String(RETENTION_DAYS_MIN);
  }

  // ===== INIT =====
  (async function init(){
setupTabs();
    $("#closeModal").addEventListener('click', closeModal);
    $("#newEntryBtn").addEventListener('click', openNewEntryModal);
    $("#saveEntryBtn").addEventListener('click', async (e)=>{ e.preventDefault(); await saveEntryFromModal(); });
    $("#addBookedBtn").addEventListener('click', async (e)=>{ e.preventDefault(); await addBookingFromModal(); });
    $("#ordersList").addEventListener('click', handleOrdersListClick);
    $("#refreshListBtn").addEventListener('click', renderOrders);
    $("#cleanupBtn").addEventListener('click', cleanupVeryOld);
    $("#trackBtn").addEventListener('click', trackLookup);

    // DB
    await openDB();
    $("#dbMode").textContent = DB_MODE;
    await ensureRetention();

    // First render
    // Header login button
    // Full-screen gate buttons
    const gateLogin = document.getElementById('authGateLogin');
    const gateCancel = document.getElementById('authGateCancel');
    const gateClose = document.getElementById('authGateClose');
    if(gateLogin){ gateLogin.addEventListener('click', handleAuthGateLogin); }
    const hideGate = ()=>{ hideAuthGate(); };
    if(gateCancel){ gateCancel.addEventListener('click', hideGate); }
    if(gateClose){ gateClose.addEventListener('click', hideGate); }
    const loginBtn = document.getElementById('loginBtn');
    if(loginBtn){ loginBtn.addEventListener('click', async ()=>{ if(!isAuthed){ showAuthGate(); } else { toast('Already logged in'); } }); }
    // AUTH hooks
    await ensureAdminCredentials();
    isAuthed = checkSessionAuth();
    // Force full-screen gate on load if not authenticated
    setTimeout(()=>{ try{ if(!isAuthed){ showAuthGate(); } }catch(e){} }, 120);
    const changeBtn = document.getElementById('changePwBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    if(changeBtn){ changeBtn.addEventListener('click', async ()=>{ if(!isAuthed){ await openLoginDialog(); return; } openChangePasswordDialog(); }); }
    if(logoutBtn){ logoutBtn.addEventListener('click', ()=>{ if(!isAuthed){ toast('Not logged in'); return; } logoutAdmin(); }); }

    renderOrders();

    // If URL has ?track=ID, prefill and track
    const params = new URLSearchParams(location.search);
    const pid = params.get('track');
    if(pid){
      document.querySelector('.tab[data-tab="home"]').click();
      $("#trackInput").value = pid;
      $("#trackBtn").click();
    }
  })();
  
  // Guard: if openLoginDialog is missing, define a minimal fallback
  if(typeof openLoginDialog !== 'function'){
    window.openLoginDialog = async function(){
      const wrap = document.getElementById('authFallback') || null;
      if(wrap){ wrap.classList.remove('hidden'); }
    }
  }


  // --- Robust admin gate (ensures login is prompted and navigation resumes after auth) ---
  (function hardenAdminGate(){
    window.pendingTab = null; const forceGateIfNeeded = async ()=>{ if(!window.isAuthed){ showAuthGate(); return true; } return false; };

    function switchToAdmin(){
      const adminTab = document.querySelector('.tab[data-tab="admin"]');
      const homeTab = document.querySelector('.tab[data-tab="home"]');
      if(adminTab && homeTab){
        adminTab.classList.add('active');
        homeTab.classList.remove('active');
      }
      const home = document.getElementById('home');
      const admin = document.getElementById('admin');
      if(home && admin){
        home.classList.add('hidden');
        admin.classList.remove('hidden');
      }
      const go = document.getElementById('goAdmin');
      if(go){ go.textContent = 'Go to Home'; }
    }

    window.afterAdminLoginSwitch = function(){
      if(window.pendingTab === 'admin'){
        switchToAdmin();
        window.pendingTab = null;
      }
    };

    function bindOnce(){
      const adminBtn = document.querySelector('.tab[data-tab="admin"]');
      if(adminBtn){
        adminBtn.addEventListener('click', async (e)=>{
          if(await forceGateIfNeeded()){
            e.preventDefault();
            e.stopImmediatePropagation();
            window.pendingTab = 'admin';
          }
        }, true);
      }
      const goBtn = document.getElementById('goAdmin');
      if(goBtn){
        goBtn.addEventListener('click', async (e)=>{
          const admin = document.getElementById('admin');
          const isAdminHidden = admin ? admin.classList.contains('hidden') : true;
          if(isAdminHidden && !window.isAuthed){
            e.preventDefault();
            e.stopImmediatePropagation();
            window.pendingTab = 'admin';
            showAuthGate();
          }
        }, true);
      }
      const hdrLogin = document.getElementById('loginBtn');
      if(hdrLogin){
        hdrLogin.addEventListener('click', async (e)=>{
          e.preventDefault();
          e.stopImmediatePropagation();
          await openLoginDialog();
        }, true);
      }
    }

    if(document.readyState === 'complete' || document.readyState === 'interactive'){
      bindOnce();
    }else{
      document.addEventListener('DOMContentLoaded', bindOnce, {once:true});
    }
  })();


  // Auto-prompt guard in case init is delayed
  document.addEventListener('DOMContentLoaded', ()=>{
    try{
      if(!window.isAuthed){ openLoginDialog(); }
    }catch(e){}
  }, {once:true});

</script>

  <!-- Fallback Auth Modal (for browsers without <dialog>) -->
  <div id="authFallback" class="fallback-modal hidden" role="dialog" aria-modal="true" aria-labelledby="authFallbackTitle">
    <div class="fallback-card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px">
        <h3 id="authFallbackTitle">Admin Login</h3>
        <button type="button" id="authFallbackClose" class="btn ghost">‚úñ</button>
      </div>
      <p class="help" style="margin-bottom:10px">Enter the admin password to access the Admin Panel.</p>
      <label for="adminUserFallback">Login ID</label>
      <input id="adminUserFallback" type="text" placeholder="e.g., admin" autocomplete="username" />
      <label for="adminPasswordFallback">Password</label>
      <input id="adminPasswordFallback" type="password" placeholder="Enter password" autocomplete="current-password" />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button type="button" class="btn ghost" id="authFallbackCancel">Cancel</button>
        <button type="button" class="btn" id="authFallbackLogin">Login</button>
      </div>
    </div>
  </div>


  <div id="loginOverlay">
    <div class="card">
      <h3 style="margin-bottom:8px">Login Required</h3>
      <p class="help" style="margin-bottom:12px">Please login to access the Admin Panel.</p>
      <button class="btn" onclick="openLoginDialog()">üîê Open Login</button>
    </div>
  </div>


  <!-- Always-on Auth Gate -->
  <div id="authGate" role="dialog" aria-modal="true" aria-labelledby="authGateTitle">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px">
        <h3 id="authGateTitle">Admin Login</h3>
        <button type="button" class="btn ghost" id="authGateClose">‚úñ</button>
      </div>
      <p class="help" style="margin-bottom:10px">Enter your Login ID and Password to continue.</p>
      <div class="row">
        <div>
          <label for="gateUser">Login ID</label>
          <input id="gateUser" type="text" placeholder="e.g., admin" autocomplete="username" />
        </div>
        <div>
          <label for="gatePass">Password</label>
          <input id="gatePass" type="password" placeholder="Password" autocomplete="current-password" />
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button type="button" class="btn ghost" id="authGateCancel">Cancel</button>
        <button type="button" class="btn" id="authGateLogin">Login</button>
      </div>
      <p class="muted" style="margin-top:10px">Default: ID <span class="mono">admin</span> / Password <span class="mono">AZ@2025</span>. Change later via Admin ‚Üí üîí Change Login.</p>
    </div>
  </div>

</body>
</html>
