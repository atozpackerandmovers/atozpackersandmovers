<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A to Z Packers & Movers - Staff Attendance v2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        .status-pill { @apply px-3 py-1 rounded-full text-xs font-medium; }
        .status-none { @apply bg-gray-700 text-gray-300; }
        .status-in { @apply bg-green-700 text-green-200; }
        .status-complete { @apply bg-blue-700 text-blue-200; }
        .status-break { @apply bg-yellow-700 text-yellow-200; }
        .status-overtime { @apply bg-purple-700 text-purple-200; }
        .btn-primary { @apply bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors; }
        .btn-secondary { @apply bg-gray-700 hover:bg-gray-600 text-white font-medium py-3 px-6 rounded-lg transition-colors; }
        .btn-success { @apply bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg transition-colors; }
        .btn-warning { @apply bg-orange-600 hover:bg-orange-700 text-white font-medium py-3 px-6 rounded-lg transition-colors; }
        .btn-danger { @apply bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-6 rounded-lg transition-colors; }
        .input-field { 
            background-color: white !important; 
            border: 1px solid #9ca3af !important; 
            color: #000000 !important; 
            border-radius: 0.5rem !important; 
            padding: 0.75rem 1rem !important; 
            outline: none !important;
        }
        .input-field:focus { 
            border-color: #3b82f6 !important; 
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5) !important; 
        }
        .input-field::placeholder { 
            color: #6b7280 !important; 
        }
        #map { height: 200px; border-radius: 0.5rem; }
        .notification-badge { @apply absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: transform 0.2s; }
        .card-hover:hover { transform: translateY(-2px); }
        .pulse-animation { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .location-status {
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 14px;
        }
        .location-success { background-color: #065f46; color: #d1fae5; }
        .location-error { background-color: #7f1d1d; color: #fecaca; }
        .location-warning { background-color: #92400e; color: #fed7aa; }
        .location-info { background-color: #1e3a8a; color: #dbeafe; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p class="text-gray-400">Loading A to Z Attendance v2.1...</p>
        </div>
    </div>

    <!-- Simple Login Screen -->
    <div id="loginScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md shadow-2xl">
            <div class="text-center mb-6">
                <div class="gradient-bg w-16 h-16 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <span class="text-2xl">üì¶</span>
                </div>
                <h1 class="text-2xl font-bold text-blue-400 mb-2">A to Z Packers & Movers</h1>
                <p class="text-gray-400">Staff Attendance System v2.1</p>
            </div>

            <div class="space-y-4">
                <input type="text" id="employeeName" placeholder="Your Full Name" class="input-field w-full">
                <input type="tel" id="employeePhone" placeholder="Phone Number" class="input-field w-full">
                <select id="employeeDepartment" class="input-field w-full">
                    <option value="">Select Department</option>
                    <option value="packing">Packing Team</option>
                    <option value="loading">Loading Team</option>
                    <option value="transport">Transport</option>
                    <option value="office">Office Staff</option>
                    <option value="management">Management</option>
                </select>
                <input type="password" id="adminPin" placeholder="Admin PIN (Optional - for admin access)" class="input-field w-full">
                <button id="loginBtn" class="btn-primary w-full">Start Attendance</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-gray-800 p-4 sticky top-0 z-40 shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-lg font-bold text-blue-400">A to Z Packers & Movers</h1>
                    <p class="text-sm text-gray-400" id="userInfo">Welcome back!</p>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="relative">
                        <button id="notificationBtn" class="p-2 hover:bg-gray-700 rounded relative">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM11 19H6.5A2.5 2.5 0 014 16.5v-9A2.5 2.5 0 016.5 5h11A2.5 2.5 0 0120 7.5v3.5"></path>
                            </svg>
                            <span id="notificationBadge" class="notification-badge hidden">0</span>
                        </button>
                    </div>
                    <span id="statusPill" class="status-pill status-none">‚Äî</span>
                    <button id="menuBtn" class="p-2 hover:bg-gray-700 rounded">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Menu Overlay -->
        <div id="menuOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
            <div class="bg-gray-800 w-64 h-full p-4">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-semibold">Menu</h2>
                    <button id="closeMenu" class="p-2 hover:bg-gray-700 rounded">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="space-y-2">
                    <button id="showAttendanceView" class="w-full text-left p-3 hover:bg-gray-700 rounded flex items-center">
                        <span class="mr-3">üìç</span> Attendance
                    </button>
                    <button id="showHistoryView" class="w-full text-left p-3 hover:bg-gray-700 rounded flex items-center">
                        <span class="mr-3">üìä</span> History
                    </button>
                    <button id="showProfileView" class="w-full text-left p-3 hover:bg-gray-700 rounded flex items-center">
                        <span class="mr-3">üë§</span> Profile
                    </button>
                    <button id="showAdminView" class="w-full text-left p-3 hover:bg-gray-700 rounded hidden flex items-center">
                        <span class="mr-3">üë•</span> Admin Panel
                    </button>
                    <hr class="border-gray-700 my-2">
                    <button id="logoutBtn" class="w-full text-left p-3 hover:bg-gray-700 rounded text-red-400 flex items-center">
                        <span class="mr-3">üö™</span> Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Attendance View -->
        <div id="attendanceView" class="p-4 space-y-6">
            <!-- Current Status Card -->
            <div class="bg-gray-800 rounded-xl p-4 card-hover">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-semibold">Today's Status</h2>
                    <div id="workingHours" class="text-sm text-gray-400">0h 0m</div>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="text-gray-400">Check-In</p>
                        <p id="checkInTime" class="font-medium">‚Äî</p>
                    </div>
                    <div>
                        <p class="text-gray-400">Check-Out</p>
                        <p id="checkOutTime" class="font-medium">‚Äî</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm mt-3">
                    <div>
                        <p class="text-gray-400">Break Time</p>
                        <p id="breakTime" class="font-medium">‚Äî</p>
                    </div>
                    <div>
                        <p class="text-gray-400">Overtime</p>
                        <p id="overtimeHours" class="font-medium">‚Äî</p>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-gray-800 rounded-xl p-4 text-center card-hover">
                    <div class="text-2xl font-bold text-green-400" id="monthlyDays">0</div>
                    <div class="text-xs text-gray-400">Days This Month</div>
                </div>
                <div class="bg-gray-800 rounded-xl p-4 text-center card-hover">
                    <div class="text-2xl font-bold text-blue-400" id="weeklyHours">0h</div>
                    <div class="text-xs text-gray-400">Hours This Week</div>
                </div>
                <div class="bg-gray-800 rounded-xl p-4 text-center card-hover">
                    <div class="text-2xl font-bold text-purple-400" id="avgHours">0h</div>
                    <div class="text-xs text-gray-400">Daily Average</div>
                </div>
            </div>

            <!-- Enhanced Location Section -->
            <div class="bg-gray-800 rounded-xl p-4 card-hover">
                <h2 class="text-lg font-semibold mb-3">üìç Location Services</h2>
                
                <!-- Location Status Display -->
                <div id="locationStatus" class="location-info">
                    <strong>üîç Location Status:</strong> Checking availability...
                </div>
                
                <!-- Location Controls -->
                <div class="grid grid-cols-1 gap-3 mb-4">
                    <button id="checkLocationBtn" class="btn-secondary">üîç Check Location Support</button>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="getLocationBtn" class="btn-secondary">üìç Auto Location</button>
                        <button id="manualLocationBtn" class="btn-secondary">‚úèÔ∏è Manual Entry</button>
                    </div>
                    <button id="testLocationBtn" class="btn-warning">üß™ Test Location Access</button>
                </div>
                
                <!-- Location Information Display -->
                <div id="locationInfo" class="hidden space-y-3">
                    <div id="map" class="bg-gray-700 rounded-lg flex items-center justify-center text-gray-400 p-4">
                        <p>üìç Location: <span id="locationDisplay">‚Äî</span></p>
                    </div>
                    <div class="text-sm space-y-1">
                        <p><span class="text-gray-400">Coordinates:</span> <span id="coordinates">‚Äî</span></p>
                        <p><span class="text-gray-400">Address:</span> <span id="address">‚Äî</span></p>
                        <p><span class="text-gray-400">Accuracy:</span> <span id="accuracy">‚Äî</span></p>
                        <p><span class="text-gray-400">Method:</span> <span id="locationMethod">‚Äî</span></p>
                    </div>
                </div>
                
                <!-- Enhanced Error Display -->
                <div id="locationError" class="hidden location-error">
                    <div class="flex items-start space-x-2">
                        <span class="text-xl">‚ö†Ô∏è</span>
                        <div class="flex-1">
                            <p class="font-medium">Location Access Issue:</p>
                            <p id="locationErrorMessage" class="mb-2">‚Äî</p>
                            <div class="text-sm">
                                <p><strong>üí° Solutions:</strong></p>
                                <div id="locationSolutions" class="ml-4 space-y-1">
                                    <!-- Solutions will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manual Location Entry Form -->
                <div id="manualLocationForm" class="hidden space-y-3 mt-4 p-4 bg-gray-700 rounded-lg">
                    <h4 class="font-medium text-blue-400">üìù Manual Location Entry</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Latitude</label>
                            <input type="number" id="manualLat" step="any" placeholder="20.2961" class="input-field w-full">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Longitude</label>
                            <input type="number" id="manualLng" step="any" placeholder="85.8245" class="input-field w-full">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Location Name (Optional)</label>
                        <input type="text" id="manualAddress" placeholder="Office, Site A, etc." class="input-field w-full">
                    </div>
                    <div class="flex space-x-2">
                        <button id="setManualLocationBtn" class="btn-success flex-1">‚úÖ Set Location</button>
                        <button id="cancelManualLocationBtn" class="btn-secondary">‚ùå Cancel</button>
                    </div>
                    <div class="text-xs text-gray-400">
                        <p>üí° <strong>Tip:</strong> You can get coordinates from Google Maps by right-clicking on a location</p>
                    </div>
                </div>
            </div>

            <!-- Attendance Actions -->
            <div class="bg-gray-800 rounded-xl p-4 card-hover">
                <h2 class="text-lg font-semibold mb-4">Actions</h2>
                <div class="grid grid-cols-2 gap-3">
                    <button id="checkInBtn" class="btn-success">‚úÖ Check In</button>
                    <button id="checkOutBtn" class="btn-warning">üèÅ Check Out</button>
                    <button id="breakStartBtn" class="btn-secondary">‚òï Start Break</button>
                    <button id="breakEndBtn" class="btn-secondary">‚è∞ End Break</button>
                </div>
                <div class="mt-3 space-y-2">
                    <button id="sendToBossBtn" class="btn-primary w-full">üì± Send to Boss</button>
                    <button id="emergencyBtn" class="btn-danger w-full">üö® Emergency Alert</button>
                </div>
            </div>

            <!-- Notes Section -->
            <div class="bg-gray-800 rounded-xl p-4 card-hover">
                <h2 class="text-lg font-semibold mb-3">Daily Notes</h2>
                <textarea id="dailyNotes" placeholder="Add notes about your work today..." 
                    class="input-field w-full h-20 resize-none"></textarea>
                <button id="saveNotesBtn" class="btn-primary mt-2">üíæ Save Notes</button>
            </div>
        </div>

        <!-- History View -->
        <div id="historyView" class="hidden p-4 space-y-6">
            <div class="bg-gray-800 rounded-xl p-4">
                <h2 class="text-lg font-semibold mb-4">Attendance History</h2>
                <div class="flex space-x-2 mb-4">
                    <select id="historyFilter" class="input-field flex-1">
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="all">All Time</option>
                    </select>
                    <button id="exportBtn" class="btn-secondary">üìä Export</button>
                </div>
                <div id="historyList" class="space-y-2">
                    <!-- History will be populated here -->
                </div>
            </div>
        </div>

        <!-- Profile View -->
        <div id="profileView" class="hidden p-4 space-y-6">
            <div class="bg-gray-800 rounded-xl p-4">
                <h2 class="text-lg font-semibold mb-4">Profile Settings</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Name</label>
                        <input type="text" id="profileName" class="input-field w-full">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Phone</label>
                        <input type="tel" id="profilePhone" class="input-field w-full">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Department</label>
                        <select id="profileDepartment" class="input-field w-full">
                            <option value="packing">Packing Team</option>
                            <option value="loading">Loading Team</option>
                            <option value="transport">Transport</option>
                            <option value="office">Office Staff</option>
                            <option value="management">Management</option>
                        </select>
                    </div>
                    <button id="updateProfileBtn" class="btn-primary">üíæ Update Profile</button>
                </div>
            </div>

            <div class="bg-gray-800 rounded-xl p-4">
                <h3 class="font-semibold mb-3">Preferences</h3>
                <div class="space-y-3">
                    <label class="flex items-center justify-between">
                        <span>Auto-location on check-in</span>
                        <input type="checkbox" id="autoLocation" class="toggle" checked>
                    </label>
                    <label class="flex items-center justify-between">
                        <span>Push notifications</span>
                        <input type="checkbox" id="pushNotifications" class="toggle" checked>
                    </label>
                    <label class="flex items-center justify-between">
                        <span>Dark mode</span>
                        <input type="checkbox" id="darkMode" class="toggle" checked>
                    </label>
                </div>
            </div>
        </div>

        <!-- Admin View -->
        <div id="adminView" class="hidden p-4 space-y-6">
            <!-- Admin Header -->
            <div class="bg-gray-800 rounded-xl p-4">
                <h2 class="text-lg font-semibold mb-3">Admin Dashboard</h2>
                <div class="text-sm space-y-1">
                    <p><span class="text-gray-400">Company:</span> A to Z Packers & Movers</p>
                    <p><span class="text-gray-400">Boss WhatsApp:</span> +91 93388 88550</p>
                    <p><span class="text-gray-400">Total Employees:</span> <span id="totalEmployees">‚Äî</span></p>
                </div>
            </div>

            <!-- Real-time Dashboard -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-800 rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold text-green-400" id="currentlyIn">0</div>
                    <div class="text-sm text-gray-400">Currently In</div>
                </div>
                <div class="bg-gray-800 rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold text-yellow-400" id="onBreak">0</div>
                    <div class="text-sm text-gray-400">On Break</div>
                </div>
            </div>

            <!-- Today's Summary -->
            <div class="bg-gray-800 rounded-xl p-4">
                <h3 class="font-semibold mb-3">Today's Summary</h3>
                <div id="todaySummary" class="grid grid-cols-4 gap-4 text-center">
                    <div><p class="text-2xl font-bold text-blue-400">0</p><p class="text-xs text-gray-400">Total</p></div>
                    <div><p class="text-2xl font-bold text-green-400">0</p><p class="text-xs text-gray-400">Active</p></div>
                    <div><p class="text-2xl font-bold text-purple-400">0</p><p class="text-xs text-gray-400">Completed</p></div>
                    <div><p class="text-2xl font-bold text-orange-400">0h</p><p class="text-xs text-gray-400">Total Hours</p></div>
                </div>
            </div>

            <!-- Staff Directory -->
            <div class="bg-gray-800 rounded-xl p-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold">Staff Directory</h3>
                    <button id="refreshStaffBtn" class="btn-secondary text-sm py-1 px-3">üîÑ Refresh</button>
                </div>
                <div id="staffDirectory" class="space-y-2">
                    <p class="text-gray-400">No staff data available in demo mode</p>
                </div>
            </div>

            <!-- Admin Actions -->
            <div class="bg-gray-800 rounded-xl p-4">
                <h3 class="font-semibold mb-3">Admin Actions</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button id="exportAllBtn" class="btn-primary">üìä Export All Data</button>
                    <button id="sendBulkBtn" class="btn-secondary">üì± Bulk Message</button>
                    <button id="resetDayBtn" class="btn-warning">üîÑ Reset Day</button>
                    <button id="backupBtn" class="btn-success">üíæ Backup Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="hidden fixed bottom-4 left-4 right-4 bg-gray-800 text-white p-4 rounded-lg shadow-lg z-50">
        <p id="toastMessage"></p>
    </div>

    <!-- Notification Panel -->
    <div id="notificationPanel" class="hidden fixed top-16 right-4 bg-gray-800 rounded-lg shadow-lg p-4 w-80 z-50">
        <h3 class="font-semibold mb-3">Notifications</h3>
        <div id="notificationList" class="space-y-2 max-h-60 overflow-y-auto">
            <p class="text-gray-400 text-sm">No new notifications</p>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            ADMIN_PIN: "9999",
            BOSS_WHATSAPP_E164: "+919338888550",
            WORK_HOURS: {
                START: "09:00",
                END: "18:00",
                BREAK_DURATION: 60 // minutes
            }
        };

        // Global State
        let currentUser = null;
        let currentLocation = null;
        let todayAttendance = null;
        let workTimer = null;
        let notifications = [];
        let attendanceHistory = [];
        let locationSupport = {
            available: false,
            permissions: 'unknown',
            https: false,
            iframe: false
        };

        // Utility Functions
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.className = `fixed bottom-4 left-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'error' ? 'bg-red-600' : 
                type === 'success' ? 'bg-green-600' : 
                type === 'warning' ? 'bg-orange-600' : 'bg-gray-800'
            } text-white`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 4000);
        }

        function updateLocationStatus(message, type = 'info') {
            const statusEl = document.getElementById('locationStatus');
            statusEl.className = `location-status location-${type}`;
            statusEl.innerHTML = `<strong>üìç Location Status:</strong> ${message}`;
        }

        function showLocationSolutions(errorType) {
            const solutionsEl = document.getElementById('locationSolutions');
            let solutions = [];

            switch(errorType) {
                case 'permission_denied':
                    solutions = [
                        '1. Click the location icon (üîí) in your browser address bar',
                        '2. Select "Allow" for location access',
                        '3. Refresh the page and try again',
                        '4. Check if location services are enabled on your device'
                    ];
                    break;
                case 'position_unavailable':
                    solutions = [
                        '1. Move to an area with better GPS signal',
                        '2. Enable location services on your device',
                        '3. Try again in a few moments',
                        '4. Use manual entry as backup'
                    ];
                    break;
                case 'timeout':
                    solutions = [
                        '1. Check your internet connection',
                        '2. Move to an area with better signal',
                        '3. Try again with a longer timeout',
                        '4. Use manual entry if GPS is slow'
                    ];
                    break;
                case 'not_supported':
                    solutions = [
                        '1. Use a modern browser (Chrome, Firefox, Safari)',
                        '2. Ensure you\'re using HTTPS connection',
                        '3. Use manual entry for location',
                        '4. Contact IT support if needed'
                    ];
                    break;
                case 'iframe_blocked':
                    solutions = [
                        '1. Open this page directly (not in iframe)',
                        '2. Ask admin to enable geolocation in iframe',
                        '3. Use manual entry for now',
                        '4. Contact technical support'
                    ];
                    break;
                default:
                    solutions = [
                        '1. Try refreshing the page',
                        '2. Use manual entry as backup',
                        '3. Check browser settings',
                        '4. Contact support if issue persists'
                    ];
            }

            solutionsEl.innerHTML = solutions.map(s => `<p>‚Ä¢ ${s}</p>`).join('');
        }

        function formatIST(date) {
            return new Intl.DateTimeFormat('en-IN', {
                timeZone: 'Asia/Kolkata',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).format(date);
        }

        function formatDuration(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}h ${mins}m`;
        }

        function calculateWorkingHours() {
            if (!todayAttendance || !todayAttendance.checkInAt) return "0h 0m";
            
            const checkIn = new Date(todayAttendance.checkInAt);
            const checkOut = todayAttendance.checkOutAt ? new Date(todayAttendance.checkOutAt) : new Date();
            const breakTime = todayAttendance.totalBreakTime || 0;
            
            const totalMinutes = Math.floor((checkOut - checkIn) / (1000 * 60)) - breakTime;
            return formatDuration(Math.max(0, totalMinutes));
        }

        function addNotification(message, type = 'info') {
            const notification = {
                id: Date.now(),
                message,
                type,
                timestamp: new Date(),
                read: false
            };
            notifications.unshift(notification);
            updateNotificationUI();
        }

        function updateNotificationUI() {
            const badge = document.getElementById('notificationBadge');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            const list = document.getElementById('notificationList');
            if (notifications.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-sm">No new notifications</p>';
            } else {
                list.innerHTML = notifications.slice(0, 10).map(n => `
                    <div class="p-2 rounded ${n.read ? 'bg-gray-700' : 'bg-blue-900'} text-sm">
                        <p>${n.message}</p>
                        <p class="text-xs text-gray-400 mt-1">${formatIST(n.timestamp)}</p>
                    </div>
                `).join('');
            }
        }

        // Local Storage Functions
        function saveToStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        function loadFromStorage(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : null;
        }

        function getTodayKey() {
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-CA', { timeZone: 'Asia/Kolkata' });
            return `attendance_${currentUser.name}_${dateStr}`;
        }

        // Enhanced Location Support Detection
        function checkLocationSupport() {
            return new Promise((resolve) => {
                const support = {
                    available: false,
                    permissions: 'unknown',
                    https: false,
                    iframe: false,
                    details: []
                };

                // Check if geolocation is available
                if (!navigator.geolocation) {
                    support.details.push('Geolocation API not supported');
                    updateLocationStatus('‚ùå Geolocation not supported by this browser', 'error');
                    showLocationSolutions('not_supported');
                    document.getElementById('locationError').classList.remove('hidden');
                    resolve(support);
                    return;
                }

                support.available = true;
                support.details.push('Geolocation API available');

                // Check HTTPS
                support.https = location.protocol === 'https:' || location.hostname === 'localhost';
                if (!support.https) {
                    support.details.push('HTTPS required for location access');
                }

                // Check if in iframe
                support.iframe = window !== window.top;
                if (support.iframe) {
                    support.details.push('Running in iframe - may have restrictions');
                }

                // Check permissions if available
                if (navigator.permissions) {
                    navigator.permissions.query({name: 'geolocation'}).then(result => {
                        support.permissions = result.state;
                        support.details.push(`Permission state: ${result.state}`);
                        
                        let statusMessage = '‚úÖ Location services available';
                        let statusType = 'success';
                        
                        if (result.state === 'denied') {
                            statusMessage = '‚ùå Location access denied';
                            statusType = 'error';
                            showLocationSolutions('permission_denied');
                            document.getElementById('locationError').classList.remove('hidden');
                        } else if (result.state === 'prompt') {
                            statusMessage = '‚ö†Ô∏è Location permission required';
                            statusType = 'warning';
                        } else if (support.iframe) {
                            statusMessage = '‚ö†Ô∏è Location available (iframe detected)';
                            statusType = 'warning';
                        }
                        
                        updateLocationStatus(statusMessage, statusType);
                        resolve(support);
                    }).catch(() => {
                        support.details.push('Permissions API not available');
                        updateLocationStatus('‚ö†Ô∏è Location available (permissions unknown)', 'warning');
                        resolve(support);
                    });
                } else {
                    support.details.push('Permissions API not available');
                    updateLocationStatus('‚ö†Ô∏è Location available (permissions unknown)', 'warning');
                    resolve(support);
                }
            });
        }

        // Authentication Functions
        function showLoginScreen() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            startWorkTimer();
            checkLocationSupport().then(support => {
                locationSupport = support;
                console.log('Location support:', support);
            });
        }

        function login(name, phone, department, adminPin) {
            if (!name || !phone || !department) {
                throw new Error('Please fill in all required fields');
            }

            const isAdmin = adminPin === CONFIG.ADMIN_PIN;
            
            currentUser = {
                name,
                phone,
                department,
                role: isAdmin ? 'admin' : 'staff',
                preferences: {
                    autoLocation: true,
                    pushNotifications: true,
                    darkMode: true
                }
            };

            saveToStorage('currentUser', currentUser);
            return currentUser;
        }

        // Enhanced Location Functions
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation is not supported by this browser'));
                    return;
                }

                updateLocationStatus('üîç Getting your location...', 'info');

                const options = {
                    enableHighAccuracy: true,
                    timeout: 45000, // Increased timeout
                    maximumAge: 300000 // 5 minutes cache
                };

                navigator.geolocation.getCurrentPosition(
                    position => {
                        console.log('Location obtained:', position.coords);
                        updateLocationStatus('‚úÖ Location obtained successfully', 'success');
                        resolve(position);
                    },
                    error => {
                        console.error('Geolocation error:', error);
                        let errorMessage = 'Location access failed. ';
                        let errorType = 'unknown';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += 'Permission denied by user or browser settings.';
                                errorType = 'permission_denied';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += 'Location information is unavailable.';
                                errorType = 'position_unavailable';
                                break;
                            case error.TIMEOUT:
                                errorMessage += 'Location request timed out.';
                                errorType = 'timeout';
                                break;
                            default:
                                errorMessage += 'An unknown error occurred.';
                                errorType = 'unknown';
                                break;
                        }
                        
                        updateLocationStatus(`‚ùå ${errorMessage}`, 'error');
                        showLocationSolutions(errorType);
                        document.getElementById('locationError').classList.remove('hidden');
                        document.getElementById('locationErrorMessage').textContent = errorMessage;
                        
                        reject(new Error(errorMessage));
                    },
                    options
                );
            });
        }

        function testLocationAccess() {
            updateLocationStatus('üß™ Testing location access...', 'info');
            
            if (!navigator.geolocation) {
                updateLocationStatus('‚ùå Geolocation not supported', 'error');
                showLocationSolutions('not_supported');
                document.getElementById('locationError').classList.remove('hidden');
                return;
            }

            // Quick test with low accuracy requirements
            const testOptions = {
                enableHighAccuracy: false,
                timeout: 10000,
                maximumAge: 600000 // 10 minutes cache
            };

            navigator.geolocation.getCurrentPosition(
                position => {
                    updateLocationStatus('‚úÖ Location test successful!', 'success');
                    showToast('Location access is working!', 'success');
                    document.getElementById('locationError').classList.add('hidden');
                },
                error => {
                    let errorType = 'unknown';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorType = 'permission_denied';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorType = 'position_unavailable';
                            break;
                        case error.TIMEOUT:
                            errorType = 'timeout';
                            break;
                    }
                    
                    updateLocationStatus('‚ùå Location test failed', 'error');
                    showLocationSolutions(errorType);
                    document.getElementById('locationError').classList.remove('hidden');
                    showToast('Location test failed - try manual entry', 'error');
                },
                testOptions
            );
        }

        function showManualLocationForm() {
            document.getElementById('manualLocationForm').classList.remove('hidden');
            document.getElementById('manualLat').focus();
        }

        function hideManualLocationForm() {
            document.getElementById('manualLocationForm').classList.add('hidden');
            document.getElementById('manualLat').value = '';
            document.getElementById('manualLng').value = '';
            document.getElementById('manualAddress').value = '';
        }

        function setManualLocation() {
            const lat = parseFloat(document.getElementById('manualLat').value);
            const lng = parseFloat(document.getElementById('manualLng').value);
            const address = document.getElementById('manualAddress').value || 'Manual Entry';

            if (isNaN(lat) || isNaN(lng)) {
                showToast('Please enter valid coordinates', 'error');
                return;
            }

            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                showToast('Coordinates out of valid range', 'error');
                return;
            }

            currentLocation = { 
                lat, 
                lng, 
                address: address + ' (Manual)', 
                accuracy: 1000,
                method: 'manual'
            };

            document.getElementById('coordinates').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            document.getElementById('address').textContent = currentLocation.address;
            document.getElementById('accuracy').textContent = '¬±1000m (Manual Entry)';
            document.getElementById('locationDisplay').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            document.getElementById('locationMethod').textContent = 'Manual Entry';
            document.getElementById('locationInfo').classList.remove('hidden');
            document.getElementById('locationError').classList.add('hidden');

            updateLocationStatus('‚úÖ Manual location set successfully', 'success');
            hideManualLocationForm();
            showToast('Manual location set successfully!', 'success');
        }

        async function reverseGeocode(lat, lng) {
            // Simplified address lookup - in a real app you'd use a geocoding service
            return `Location: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
        }

        // Attendance Functions
        function loadTodayAttendance() {
            if (!currentUser) return;

            const todayKey = getTodayKey();
            todayAttendance = loadFromStorage(todayKey);
            updateAttendanceUI();
            loadQuickStats();
        }

        function updateAttendanceUI() {
            const statusPill = document.getElementById('statusPill');
            const checkInTime = document.getElementById('checkInTime');
            const checkOutTime = document.getElementById('checkOutTime');
            const breakTime = document.getElementById('breakTime');
            const overtimeHours = document.getElementById('overtimeHours');
            const workingHours = document.getElementById('workingHours');
            
            const checkInBtn = document.getElementById('checkInBtn');
            const checkOutBtn = document.getElementById('checkOutBtn');
            const breakStartBtn = document.getElementById('breakStartBtn');
            const breakEndBtn = document.getElementById('breakEndBtn');

            if (!todayAttendance) {
                statusPill.className = 'status-pill status-none';
                statusPill.textContent = '‚Äî';
                checkInTime.textContent = '‚Äî';
                checkOutTime.textContent = '‚Äî';
                breakTime.textContent = '‚Äî';
                overtimeHours.textContent = '‚Äî';
                workingHours.textContent = '0h 0m';
                
                checkInBtn.disabled = false;
                checkOutBtn.disabled = true;
                breakStartBtn.disabled = true;
                breakEndBtn.disabled = true;
            } else {
                workingHours.textContent = calculateWorkingHours();
                
                if (todayAttendance.checkInAt) {
                    checkInTime.textContent = formatIST(new Date(todayAttendance.checkInAt));
                    checkInBtn.disabled = true;
                    breakStartBtn.disabled = false;
                }
                
                if (todayAttendance.checkOutAt) {
                    checkOutTime.textContent = formatIST(new Date(todayAttendance.checkOutAt));
                    statusPill.className = 'status-pill status-complete';
                    statusPill.textContent = 'Completed';
                    checkOutBtn.disabled = true;
                    breakStartBtn.disabled = true;
                    breakEndBtn.disabled = true;
                } else if (todayAttendance.onBreak) {
                    statusPill.className = 'status-pill status-break';
                    statusPill.textContent = 'On Break';
                    checkOutBtn.disabled = false;
                    breakStartBtn.disabled = true;
                    breakEndBtn.disabled = false;
                } else if (todayAttendance.checkInAt) {
                    statusPill.className = 'status-pill status-in';
                    statusPill.textContent = 'Checked-In';
                    checkOutBtn.disabled = false;
                    breakEndBtn.disabled = true;
                }
                
                breakTime.textContent = formatDuration(todayAttendance.totalBreakTime || 0);
                
                // Calculate overtime
                if (todayAttendance.checkInAt) {
                    const workMinutes = Math.floor((new Date() - new Date(todayAttendance.checkInAt)) / (1000 * 60));
                    const standardWorkDay = 9 * 60; // 9 hours
                    const overtime = Math.max(0, workMinutes - standardWorkDay - (todayAttendance.totalBreakTime || 0));
                    overtimeHours.textContent = formatDuration(overtime);
                }
            }
        }

        function loadQuickStats() {
            if (!currentUser) return;

            // Load from localStorage - simplified stats
            const allAttendance = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(`attendance_${currentUser.name}_`)) {
                    const data = loadFromStorage(key);
                    if (data) allAttendance.push(data);
                }
            }

            // Calculate stats
            const thisMonth = allAttendance.filter(a => {
                const date = new Date(a.checkInAt);
                const now = new Date();
                return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            });

            let totalMinutes = 0;
            thisMonth.forEach(a => {
                if (a.checkInAt && a.checkOutAt) {
                    const duration = (new Date(a.checkOutAt) - new Date(a.checkInAt)) / (1000 * 60);
                    totalMinutes += duration - (a.totalBreakTime || 0);
                }
            });

            document.getElementById('monthlyDays').textContent = thisMonth.length;
            document.getElementById('weeklyHours').textContent = formatDuration(totalMinutes);
            document.getElementById('avgHours').textContent = formatDuration(thisMonth.length > 0 ? totalMinutes / thisMonth.length : 0);
        }

        function startWorkTimer() {
            if (workTimer) clearInterval(workTimer);
            
            workTimer = setInterval(() => {
                if (todayAttendance && todayAttendance.checkInAt && !todayAttendance.checkOutAt) {
                    document.getElementById('workingHours').textContent = calculateWorkingHours();
                }
            }, 60000); // Update every minute
        }

        async function checkIn() {
            if (!currentLocation) {
                showToast('Please get your location first', 'error');
                return;
            }

            const now = new Date();
            const todayKey = getTodayKey();

            todayAttendance = {
                name: currentUser.name,
                phone: currentUser.phone,
                department: currentUser.department,
                date: now.toLocaleDateString('en-CA', { timeZone: 'Asia/Kolkata' }),
                checkInAt: now.toISOString(),
                checkInLat: currentLocation.lat,
                checkInLng: currentLocation.lng,
                checkInAddress: currentLocation.address,
                checkInMethod: currentLocation.method || 'gps',
                status: 'checked-in',
                totalBreakTime: 0,
                onBreak: false,
                notes: ''
            };

            saveToStorage(todayKey, todayAttendance);
            updateAttendanceUI();
            addNotification('Successfully checked in!', 'success');
            showToast('Checked in successfully!', 'success');
        }

        async function checkOut() {
            if (!currentLocation) {
                showToast('Please get your location first', 'error');
                return;
            }

            const now = new Date();
            const todayKey = getTodayKey();

            // End any active break
            if (todayAttendance.onBreak && todayAttendance.breakStartAt) {
                const breakDuration = Math.floor((now - new Date(todayAttendance.breakStartAt)) / (1000 * 60));
                todayAttendance.totalBreakTime = (todayAttendance.totalBreakTime || 0) + breakDuration;
            }

            todayAttendance.checkOutAt = now.toISOString();
            todayAttendance.checkOutLat = currentLocation.lat;
            todayAttendance.checkOutLng = currentLocation.lng;
            todayAttendance.checkOutAddress = currentLocation.address;
            todayAttendance.checkOutMethod = currentLocation.method || 'gps';
            todayAttendance.status = 'completed';
            todayAttendance.onBreak = false;

            saveToStorage(todayKey, todayAttendance);
            updateAttendanceUI();
            addNotification('Successfully checked out!', 'success');
            showToast('Checked out successfully!', 'success');
        }

        async function startBreak() {
            const now = new Date();
            const todayKey = getTodayKey();

            todayAttendance.onBreak = true;
            todayAttendance.breakStartAt = now.toISOString();

            saveToStorage(todayKey, todayAttendance);
            updateAttendanceUI();
            addNotification('Break started', 'info');
            showToast('Break started', 'info');
        }

        async function endBreak() {
            const now = new Date();
            const todayKey = getTodayKey();
            
            const breakDuration = Math.floor((now - new Date(todayAttendance.breakStartAt)) / (1000 * 60));
            todayAttendance.totalBreakTime = (todayAttendance.totalBreakTime || 0) + breakDuration;
            todayAttendance.onBreak = false;
            delete todayAttendance.breakStartAt;

            saveToStorage(todayKey, todayAttendance);
            updateAttendanceUI();
            addNotification(`Break ended (${formatDuration(breakDuration)})`, 'info');
            showToast(`Break ended (${formatDuration(breakDuration)})`, 'info');
        }

        function generateWhatsAppMessage() {
            if (!todayAttendance || !currentLocation) {
                showToast('No attendance data available', 'error');
                return;
            }

            let message = `üè¢ A to Z Packers & Movers ‚Äî Attendance Report\n\n`;
            message += `üë§ Employee: ${todayAttendance.name}\n`;
            message += `üì± Phone: ${todayAttendance.phone}\n`;
            message += `üè∑Ô∏è Department: ${todayAttendance.department}\n`;
            message += `üìÖ Date: ${todayAttendance.date}\n\n`;

            if (todayAttendance.checkInAt) {
                message += `‚è∞ Check-In: ${formatIST(new Date(todayAttendance.checkInAt))} IST\n`;
                message += `üìç In Location: ${todayAttendance.checkInLat},${todayAttendance.checkInLng}\n`;
                message += `üîç In Method: ${todayAttendance.checkInMethod || 'GPS'}\n`;
            }

            if (todayAttendance.checkOutAt) {
                message += `‚è∞ Check-Out: ${formatIST(new Date(todayAttendance.checkOutAt))} IST\n`;
                message += `üìç Out Location: ${todayAttendance.checkOutLat},${todayAttendance.checkOutLng}\n`;
                message += `üîç Out Method: ${todayAttendance.checkOutMethod || 'GPS'}\n`;
                message += `‚è±Ô∏è Total Hours: ${calculateWorkingHours()}\n`;
                message += `‚òï Break Time: ${formatDuration(todayAttendance.totalBreakTime || 0)}\n`;
            }

            message += `\nüó∫Ô∏è Map: https://maps.google.com/?q=${currentLocation.lat},${currentLocation.lng}`;

            if (todayAttendance.notes) {
                message += `\nüìù Notes: ${todayAttendance.notes}`;
            }

            const whatsappUrl = `https://wa.me/${CONFIG.BOSS_WHATSAPP_E164.replace('+', '')}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function loadHistory(filter = 'week') {
            if (!currentUser) return;

            const allAttendance = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(`attendance_${currentUser.name}_`)) {
                    const data = loadFromStorage(key);
                    if (data) allAttendance.push(data);
                }
            }

            // Filter by date range
            let filteredAttendance = allAttendance;
            const now = new Date();
            
            if (filter === 'week') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filteredAttendance = allAttendance.filter(a => new Date(a.checkInAt) >= weekAgo);
            } else if (filter === 'month') {
                filteredAttendance = allAttendance.filter(a => {
                    const date = new Date(a.checkInAt);
                    return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
                });
            }

            // Sort by date (newest first)
            filteredAttendance.sort((a, b) => new Date(b.checkInAt) - new Date(a.checkInAt));

            const historyHtml = filteredAttendance.map(data => {
                const duration = data.checkOutAt ? 
                    Math.floor((new Date(data.checkOutAt) - new Date(data.checkInAt)) / (1000 * 60)) - (data.totalBreakTime || 0) :
                    0;
                
                return `
                    <div class="bg-gray-700 rounded-lg p-3">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium">${data.date}</span>
                            <span class="text-sm ${data.status === 'completed' ? 'text-green-400' : 'text-yellow-400'}">
                                ${data.status === 'completed' ? '‚úÖ Completed' : '‚è≥ In Progress'}
                            </span>
                        </div>
                        <div class="text-sm text-gray-300 space-y-1">
                            <p>In: ${formatIST(new Date(data.checkInAt))} ${data.checkInMethod ? `(${data.checkInMethod})` : ''}</p>
                            ${data.checkOutAt ? `<p>Out: ${formatIST(new Date(data.checkOutAt))} ${data.checkOutMethod ? `(${data.checkOutMethod})` : ''}</p>` : ''}
                            ${data.checkOutAt ? `<p>Duration: ${formatDuration(duration)}</p>` : ''}
                            ${data.totalBreakTime ? `<p>Break: ${formatDuration(data.totalBreakTime)}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('historyList').innerHTML = historyHtml || '<p class="text-gray-400">No attendance records found</p>';
        }

        function loadProfile() {
            if (!currentUser) return;

            document.getElementById('profileName').value = currentUser.name;
            document.getElementById('profilePhone').value = currentUser.phone;
            document.getElementById('profileDepartment').value = currentUser.department;
            
            if (currentUser.preferences) {
                document.getElementById('autoLocation').checked = currentUser.preferences.autoLocation;
                document.getElementById('pushNotifications').checked = currentUser.preferences.pushNotifications;
                document.getElementById('darkMode').checked = currentUser.preferences.darkMode;
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is already logged in
            const savedUser = loadFromStorage('currentUser');
            if (savedUser) {
                currentUser = savedUser;
                document.getElementById('userInfo').textContent = `Welcome, ${currentUser.name}!`;
                
                if (currentUser.role === 'admin') {
                    document.getElementById('showAdminView').classList.remove('hidden');
                }
                
                showMainApp();
                loadTodayAttendance();
            } else {
                showLoginScreen();
            }

            // Login action
            document.getElementById('loginBtn').addEventListener('click', async () => {
                const name = document.getElementById('employeeName').value;
                const phone = document.getElementById('employeePhone').value;
                const department = document.getElementById('employeeDepartment').value;
                const adminPin = document.getElementById('adminPin').value;

                try {
                    login(name, phone, department, adminPin);
                    document.getElementById('userInfo').textContent = `Welcome, ${currentUser.name}!`;
                    
                    if (currentUser.role === 'admin') {
                        document.getElementById('showAdminView').classList.remove('hidden');
                    }
                    
                    showMainApp();
                    loadTodayAttendance();
                } catch (error) {
                    showToast(error.message, 'error');
                }
            });

            // Menu actions
            document.getElementById('menuBtn').addEventListener('click', () => {
                document.getElementById('menuOverlay').classList.remove('hidden');
            });

            document.getElementById('closeMenu').addEventListener('click', () => {
                document.getElementById('menuOverlay').classList.add('hidden');
            });

            // View switching
            document.getElementById('showAttendanceView').addEventListener('click', () => {
                document.querySelectorAll('[id$="View"]').forEach(view => view.classList.add('hidden'));
                document.getElementById('attendanceView').classList.remove('hidden');
                document.getElementById('menuOverlay').classList.add('hidden');
            });

            document.getElementById('showHistoryView').addEventListener('click', () => {
                document.querySelectorAll('[id$="View"]').forEach(view => view.classList.add('hidden'));
                document.getElementById('historyView').classList.remove('hidden');
                document.getElementById('menuOverlay').classList.add('hidden');
                loadHistory();
            });

            document.getElementById('showProfileView').addEventListener('click', () => {
                document.querySelectorAll('[id$="View"]').forEach(view => view.classList.add('hidden'));
                document.getElementById('profileView').classList.remove('hidden');
                document.getElementById('menuOverlay').classList.add('hidden');
                loadProfile();
            });

            document.getElementById('showAdminView').addEventListener('click', () => {
                document.querySelectorAll('[id$="View"]').forEach(view => view.classList.add('hidden'));
                document.getElementById('adminView').classList.remove('hidden');
                document.getElementById('menuOverlay').classList.add('hidden');
            });

            document.getElementById('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('currentUser');
                currentUser = null;
                if (workTimer) clearInterval(workTimer);
                showLoginScreen();
            });

            // Notification panel
            document.getElementById('notificationBtn').addEventListener('click', () => {
                const panel = document.getElementById('notificationPanel');
                panel.classList.toggle('hidden');
                // Mark all as read when opened
                notifications.forEach(n => n.read = true);
                updateNotificationUI();
            });

            // Enhanced location actions
            document.getElementById('checkLocationBtn').addEventListener('click', async () => {
                const support = await checkLocationSupport();
                console.log('Location support check:', support);
                showToast('Location support checked - see status above', 'info');
            });

            document.getElementById('testLocationBtn').addEventListener('click', testLocationAccess);

            document.getElementById('getLocationBtn').addEventListener('click', async () => {
                try {
                    showToast('Getting location...', 'info');
                    const position = await getCurrentLocation();
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    const address = await reverseGeocode(lat, lng);

                    currentLocation = { lat, lng, address, accuracy, method: 'gps' };

                    document.getElementById('coordinates').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    document.getElementById('address').textContent = address;
                    document.getElementById('accuracy').textContent = `¬±${Math.round(accuracy)}m`;
                    document.getElementById('locationDisplay').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                    document.getElementById('locationMethod').textContent = 'GPS';
                    document.getElementById('locationInfo').classList.remove('hidden');
                    document.getElementById('locationError').classList.add('hidden');

                    showToast('Location updated successfully!', 'success');
                } catch (error) {
                    console.error('Location error:', error);
                    showToast('Location access failed - try manual entry', 'error');
                }
            });

            document.getElementById('manualLocationBtn').addEventListener('click', showManualLocationForm);
            document.getElementById('setManualLocationBtn').addEventListener('click', setManualLocation);
            document.getElementById('cancelManualLocationBtn').addEventListener('click', hideManualLocationForm);

            document.getElementById('checkInBtn').addEventListener('click', checkIn);
            document.getElementById('checkOutBtn').addEventListener('click', checkOut);
            document.getElementById('breakStartBtn').addEventListener('click', startBreak);
            document.getElementById('breakEndBtn').addEventListener('click', endBreak);
            
            document.getElementById('sendToBossBtn').addEventListener('click', () => {
                if (!todayAttendance) {
                    showToast('No attendance data to send', 'error');
                    return;
                }
                generateWhatsAppMessage();
            });

            document.getElementById('emergencyBtn').addEventListener('click', () => {
                if (!currentLocation) {
                    showToast('Please get your location first', 'error');
                    return;
                }
                
                const message = `üö® EMERGENCY ALERT - A to Z Packers & Movers\n\nEmployee needs immediate assistance!\n\nLocation: ${currentLocation.lat},${currentLocation.lng}\nAddress: ${currentLocation.address}\nTime: ${formatIST(new Date())} IST\n\nMap: https://maps.google.com/?q=${currentLocation.lat},${currentLocation.lng}`;
                const whatsappUrl = `https://wa.me/${CONFIG.BOSS_WHATSAPP_E164.replace('+', '')}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                showToast('Emergency alert sent!', 'warning');
            });

            // Notes
            document.getElementById('saveNotesBtn').addEventListener('click', async () => {
                if (!todayAttendance) {
                    showToast('No attendance record for today', 'error');
                    return;
                }

                const notes = document.getElementById('dailyNotes').value;
                const todayKey = getTodayKey();
                
                todayAttendance.notes = notes;
                saveToStorage(todayKey, todayAttendance);
                showToast('Notes saved successfully!', 'success');
            });

            // History filter
            document.getElementById('historyFilter').addEventListener('change', (e) => {
                loadHistory(e.target.value);
            });

            // Profile update
            document.getElementById('updateProfileBtn').addEventListener('click', async () => {
                const phone = document.getElementById('profilePhone').value;
                const department = document.getElementById('profileDepartment').value;
                const preferences = {
                    autoLocation: document.getElementById('autoLocation').checked,
                    pushNotifications: document.getElementById('pushNotifications').checked,
                    darkMode: document.getElementById('darkMode').checked
                };

                currentUser.phone = phone;
                currentUser.department = department;
                currentUser.preferences = preferences;
                
                saveToStorage('currentUser', currentUser);
                showToast('Profile updated successfully!', 'success');
            });

            // Export functionality
            document.getElementById('exportBtn').addEventListener('click', () => {
                const allAttendance = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith(`attendance_${currentUser.name}_`)) {
                        const data = loadFromStorage(key);
                        if (data) allAttendance.push(data);
                    }
                }
                
                const csvContent = "data:text/csv;charset=utf-8," 
                    + "Date,Check In,Check Out,Break Time,Total Hours,Notes\n"
                    + allAttendance.map(a => {
                        const duration = a.checkOutAt ? 
                            Math.floor((new Date(a.checkOutAt) - new Date(a.checkInAt)) / (1000 * 60)) - (a.totalBreakTime || 0) :
                            0;
                        return `${a.date},${formatIST(new Date(a.checkInAt))},${a.checkOutAt ? formatIST(new Date(a.checkOutAt)) : ''},${formatDuration(a.totalBreakTime || 0)},${formatDuration(duration)},"${a.notes || ''}"`;
                    }).join("\n");

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `attendance_${currentUser.name}_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Attendance data exported!', 'success');
            });

            // Close notification panel when clicking outside
            document.addEventListener('click', (e) => {
                const panel = document.getElementById('notificationPanel');
                const btn = document.getElementById('notificationBtn');
                if (!panel.contains(e.target) && !btn.contains(e.target)) {
                    panel.classList.add('hidden');
                }
            });

            // Load daily notes if exists
            setTimeout(() => {
                if (todayAttendance && todayAttendance.notes) {
                    document.getElementById('dailyNotes').value = todayAttendance.notes;
                }
            }, 1000);
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97978e439021836f',t:'MTc1NjkyNjcxNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>